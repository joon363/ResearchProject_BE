name: Deploy to AWS

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy via SSH
      run: |
        # SSH 키를 임시 파일로 저장
        echo "${{ secrets.AWS_SSH_KEY }}" > my_ssh_key
        chmod 600 my_ssh_key

        # SSH 접속 후 배포
        ssh -o StrictHostKeyChecking=no -i my_ssh_key ubuntu@${{ secrets.AWS_HOST }} << 'EOF'
          cd ~/my-api
          git reset --hard HEAD
          git pull origin main
          
          sudo docker build -t myapi .
          sudo docker stop myapi || true
          sudo docker rm myapi || true
          sudo docker run -d -p 80:5000 --name myapi myapi
        EOF
      shell: bash
